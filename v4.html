<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Light ìë§‰ ìƒì„±ê¸° (Web Speech API ë²„ì „)</title>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/util@0.12.1/dist/umd/index.min.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; padding: 20px; background: #f9f9f9; }
        .container { max-width: 600px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        #log { background: #222; color: #00ff00; padding: 15px; height: 150px; overflow-y: auto; font-size: 13px; border-radius: 8px; margin: 15px 0; white-space: pre-wrap; }
        button { width: 100%; padding: 12px; background: #4A90E2; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:disabled { background: #ccc; }
        .result-area { margin-top: 20px; border-top: 2px solid #eee; padding-top: 15px; }
        #srtPreview { width: 100%; height: 150px; background: #f0f0f0; border: 1px solid #ddd; padding: 10px; box-sizing: border-box; font-size: 12px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ¤ ìˆœìˆ˜ ë¸Œë¼ìš°ì € ìë§‰ê¸°</h2>
    <p style="font-size: 0.9em; color: #666;">ìœ„ìŠ¤í¼ ì—†ì´ ë¸Œë¼ìš°ì € ë‚´ì¥ ê¸°ëŠ¥ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤.</p>
    
    <input type="file" id="videoInput" accept="video/*, audio/*">
    <button id="startBtn">ìë§‰ ë°›ì•„ì“°ê¸° ì‹œì‘</button>
    
    <div id="log">ì¤€ë¹„ ì™„ë£Œ. íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.</div>
    
    <div class="result-area">
        <strong>ì‹¤ì‹œê°„ ìë§‰ ê²°ê³¼:</strong>
        <textarea id="srtPreview" readonly placeholder="ì´ê³³ì— SRT ë‚´ìš©ì´ ì±„ì›Œì§‘ë‹ˆë‹¤..."></textarea>
        <button id="downBtn" style="background:#28a745; margin-top:10px; display:none;">SRT ë‹¤ìš´ë¡œë“œ</button>
    </div>
</div>

<audio id="audioPlayer" style="display:none;"></audio>

<script type="module">
    const { FFmpeg } = FFmpegWASM;
    const { fetchFile, toBlobURL } = FFmpegUtil;
    const ffmpeg = new FFmpeg();

    const logDiv = document.getElementById('log');
    const srtPreview = document.getElementById('srtPreview');
    const startBtn = document.getElementById('startBtn');
    const downBtn = document.getElementById('downBtn');
    const audioPlayer = document.getElementById('audioPlayer');

    let srtData = [];
    let startTime = 0;

    function addLog(msg) {
        logDiv.innerText += `\n> ${msg}`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    startBtn.onclick = async () => {
        const file = document.getElementById('videoInput').files[0];
        if (!file) return alert("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”!");

        try {
            startBtn.disabled = true;
            srtData = [];
            srtPreview.value = "";
            addLog("ì‹œìŠ¤í…œ ê°€ë™ ì¤‘...");

            // 1. FFmpegë¡œ ì˜¤ë””ì˜¤ ì¶”ì¶œ
            if (!ffmpeg.loaded) {
                await ffmpeg.load({
                    coreURL: await toBlobURL('https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.js', 'text/javascript'),
                    wasmURL: await toBlobURL('https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.wasm', 'application/wasm'),
                });
            }
            addLog("ì˜¤ë””ì˜¤ ë°ì´í„° ë¶„ë¦¬ ì¤‘...");
            await ffmpeg.writeFile('input', await fetchFile(file));
            await ffmpeg.exec(['-i', 'input', '-ar', '16000', '-ac', '1', 'output.mp3']);
            const data = await ffmpeg.readFile('output.wav');
            
            // 2. ì˜¤ë””ì˜¤ë¥¼ í”Œë ˆì´ì–´ì— ì„¸íŒ…
            const audioBlob = new Blob([data.buffer], { type: 'audio/wav' });
            audioPlayer.src = URL.createObjectURL(audioBlob);

            // 3. Web Speech API ì„¤ì •
            const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!Recognition) return alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (í¬ë¡¬ ê¶Œì¥)");

            const recognition = new Recognition();
            recognition.lang = 'ko-KR';
            recognition.continuous = true; // ê³„ì† ì¸ì‹
            recognition.interimResults = false; // ìµœì¢… ê²°ê³¼ë§Œ

            recognition.onstart = () => {
                addLog("ë°›ì•„ì“°ê¸° ì‹œì‘... (ì˜¤ë””ì˜¤ ì¬ìƒ ì¤‘)");
                startTime = Date.now();
                audioPlayer.play();
            };

            recognition.onresult = (event) => {
                const lastResult = event.results[event.results.length - 1];
                const text = lastResult[0].transcript;
                const currentTime = audioPlayer.currentTime;
                
                // ê°„ë‹¨í•œ íƒ€ì„ìŠ¤íƒ¬í”„ ê³„ì‚° (í˜„ì¬ ì¬ìƒ ì§€ì  ê¸°ë°˜)
                const entry = {
                    index: srtData.length + 1,
                    start: formatSRTTime(currentTime - 2 > 0 ? currentTime - 2 : 0),
                    end: formatSRTTime(currentTime),
                    text: text.trim()
                };
                
                srtData.push(entry);
                updatePreview();
            };

            recognition.onend = () => {
                addLog("ëª¨ë“  ì¸ì‹ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                downBtn.style.display = "block";
                startBtn.disabled = false;
            };

            recognition.onerror = (e) => addLog("ì¸ì‹ ì˜¤ë¥˜: " + e.error);

            // ì¸ì‹ ì‹œì‘
            recognition.start();

        } catch (err) {
            addLog("ì˜¤ë¥˜: " + err.message);
            startBtn.disabled = false;
        }
    };

    function updatePreview() {
        srtPreview.value = srtData.map(d => 
            `${d.index}\n${d.start} --> ${d.end}\n${d.text}\n`
        ).join('\n');
        srtPreview.scrollTop = srtPreview.scrollHeight;
    }

    function formatSRTTime(sec) {
        const date = new Date(0);
        date.setMilliseconds(sec * 1000);
        const timePart = date.toISOString().substr(11, 8);
        const msPart = Math.floor((sec % 1) * 1000).toString().padStart(3, '0');
        return `${timePart},${msPart}`;
    }

    downBtn.onclick = () => {
        const blob = new Blob([srtPreview.value], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "subtitle.srt";
        a.click();
    };
</script>

</body>
</html>
