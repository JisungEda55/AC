<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whisper WASM ìë§‰ ìƒì„±ê¸°</title>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/util@0.12.1/dist/umd/index.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 30px; line-height: 1.6; max-width: 800px; margin: 0 auto; background-color: #f4f4f9; }
        .container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        video { width: 100%; border-radius: 8px; margin-top: 15px; display: none; }
        #status { font-weight: bold; color: #007bff; margin: 15px 0; min-height: 24px; }
        .controls { margin: 20px 0; display: flex; gap: 10px; }
        button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        #startBtn { background-color: #28a745; color: white; }
        #startBtn:disabled { background-color: #ccc; }
        #downloadBtn { background-color: #17a2b8; color: white; }
        #downloadBtn:disabled { background-color: #ccc; }
        pre { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 8px; overflow-x: auto; max-height: 300px; font-size: 13px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ™ï¸ On-Device ìë§‰ ìƒì„±ê¸°</h2>
    <p><small>ì„œë²„ ì „ì†¡ ì—†ì´ ë¸Œë¼ìš°ì € ë‚´ì—ì„œ ëª¨ë“  ì²˜ë¦¬ê°€ ì™„ë£Œë©ë‹ˆë‹¤.</small></p>

    <input type="file" id="videoInput" accept="video/*">
    <video id="videoPlayer" controls></video>

    <div class="controls">
        <button id="startBtn">ìë§‰ ì¶”ì¶œ ì‹œì‘</button>
        <button id="downloadBtn" disabled>SRT ë‹¤ìš´ë¡œë“œ</button>
    </div>

    <div id="status">íŒŒì¼ì„ ì„ íƒí•˜ê³  'ì‹œì‘'ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
    
    <h3>ìë§‰ ë¯¸ë¦¬ë³´ê¸°</h3>
    <pre id="output">ì´ê³³ì— ìë§‰ì´ í‘œì‹œë©ë‹ˆë‹¤...</pre>
</div>

<script type="module">
    // Transformers.jsëŠ” ëª¨ë“ˆ ë°©ì‹ìœ¼ë¡œ ê°€ì ¸ì˜¤ê±°ë‚˜ ì›Œì»¤ ë‚´ë¶€ì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.
    // ì—¬ê¸°ì„œëŠ” ì›Œì»¤ë¥¼ ì‚¬ìš©í•˜ì—¬ UI ë©ˆì¶¤ì„ ë°©ì§€í•©ë‹ˆë‹¤.

    const { FFmpeg } = FFmpegWASM;
    const { fetchFile, toBlobURL } = FFmpegUtil;
    
    const ffmpeg = new FFmpeg();
    const videoInput = document.getElementById('videoInput');
    const videoPlayer = document.getElementById('videoPlayer');
    const startBtn = document.getElementById('startBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const status = document.getElementById('status');
    const output = document.getElementById('output');

    let srtResult = "";

    // 1. ë¹„ë””ì˜¤ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸°
    videoInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            videoPlayer.src = URL.createObjectURL(file);
            videoPlayer.style.display = "block";
        }
    };

    // 2. ë©”ì¸ ì‹¤í–‰ ë¡œì§
    startBtn.onclick = async () => {
        const file = videoInput.files[0];
        if (!file) return alert("íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!");

        try {
            startBtn.disabled = true;
            
            // FFmpeg ë¡œë“œ
            if (!ffmpeg.loaded) {
                status.innerText = "âš¡ FFmpeg ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì¤‘...";
                await ffmpeg.load({
                    coreURL: await toBlobURL('https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.js', 'text/javascript'),
                    wasmURL: await toBlobURL('https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.wasm', 'application/wasm'),
                });
            }

            // ì˜¤ë””ì˜¤ ì¶”ì¶œ (16kHz, mono, wav)
            status.innerText = "ğŸ”Š ì˜¤ë””ì˜¤ ì¶”ì¶œ ë° ë³€í™˜ ì¤‘...";
            await ffmpeg.writeFile('input_video', await fetchFile(file));
            await ffmpeg.exec(['-i', 'input_video', '-ar', '16000', '-ac', '1', '-c:a', 'pcm_s16le', 'output.wav']);
            
            const audioData = await ffmpeg.readFile('output.wav');
            const audioBlob = new Blob([audioData.buffer], { type: 'audio/wav' });
            const audioUrl = URL.createObjectURL(audioBlob);

            // Whisper Worker ì‹¤í–‰
            status.innerText = "ğŸ§  AI ëª¨ë¸ ë¡œë“œ ë° ìŒì„± ì¸ì‹ ì¤‘ (ìµœì´ˆ ì‹¤í–‰ ì‹œ ëª¨ë¸ ë‹¤ìš´ë¡œë“œë¡œ ì¸í•´ ì‹œê°„ì´ ê±¸ë¦½ë‹ˆë‹¤)...";
            runWhisper(audioBlob);

        } catch (err) {
            console.error(err);
            status.innerText = "âŒ ì˜¤ë¥˜ ë°œìƒ: " + err.message;
            startBtn.disabled = false;
        }
    };

    // 3. Whisper (Transformers.js) Web Worker ì²˜ë¦¬
    function runWhisper(blob) {
        // ì›Œì»¤ ì½”ë“œë¥¼ ë¬¸ìì—´ë¡œ ì‘ì„±í•˜ì—¬ Blob ê°ì²´ë¡œ ë§Œë“¦ (ë‹¨ì¼ íŒŒì¼ ìœ ì§€)
        const workerCode = `
            import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

            self.onmessage = async (e) => {
                const { audioUrl } = e.data;
                
                try {
                    // Whisper 'tiny' ëª¨ë¸ íŒŒì´í”„ë¼ì¸ ìƒì„± (í•œêµ­ì–´ íƒ€ê²Ÿ)
                    const transcriber = await pipeline('automatic-speech-recognition', 'Xenova/whisper-tiny');
                    
                    const result = await transcriber(audioUrl, { 
                        language: 'korean',
                        chunk_length_s: 30,
                        stride_length_s: 5,
                        return_timestamps: true 
                    });

                    self.postMessage({ status: 'success', data: result });
                } catch (err) {
                    self.postMessage({ status: 'error', message: err.message });
                }
            };
        `;

        const workerBlob = new Blob([workerCode], { type: 'application/javascript' });
        const worker = new Worker(URL.createObjectURL(workerBlob), { type: 'module' });

        worker.postMessage({ audioUrl: URL.createObjectURL(blob) });

        worker.onmessage = (e) => {
            if (e.data.status === 'success') {
                const result = e.data.data;
                srtResult = convertToSRT(result.chunks);
                output.textContent = srtResult;
                status.innerText = "âœ… ìë§‰ ìƒì„± ì™„ë£Œ!";
                downloadBtn.disabled = false;
            } else {
                status.innerText = "âŒ ì¸ì‹ ì‹¤íŒ¨: " + e.data.message;
            }
            startBtn.disabled = false;
        };
    }

    // 4. SRT í¬ë§· ë³€í™˜ í•¨ìˆ˜
    function convertToSRT(chunks) {
        return chunks.map((chunk, index) => {
            const start = formatTime(chunk.timestamp[0]);
            const end = formatTime(chunk.timestamp[1] || chunk.timestamp[0] + 2);
            return \`\${index + 1}\\n\${start} --> \${end}\\n\${chunk.text.trim()}\\n\\n\`;
        }).join('');
    }

    function formatTime(seconds) {
        const date = new Date(0);
        date.setMilliseconds(seconds * 1000);
        const timePart = date.toISOString().substr(11, 8);
        const msPart = Math.floor((seconds % 1) * 1000).toString().padStart(3, '0');
        return \`\${timePart},\${msPart}\`;
    }

    // 5. ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥
    downloadBtn.onclick = () => {
        const blob = new Blob([srtResult], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "subtitle.srt";
        a.click();
    };
</script>

</body>
</html>
